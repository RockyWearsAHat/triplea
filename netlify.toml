# Triple A Apps - Unified Netlify Configuration
#
# One Netlify site serves three apps by routing based on the request Host.
# This allows you to attach separate domains like:
#   - tripleamusic.com        → Music app
#   - tripleamuse.com         → Muse app
#   - tripleamusician.com     → Musician app
#
# The shared API is hosted as Netlify Functions and exposed at /api/*.

[build]
  publish = "dist"
  command = "npm ci && npm ci --prefix server && npm ci --prefix TripleAMusic && npm ci --prefix TripleAMusician && npm ci --prefix TripleAMuse && npm run build"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"
  NETLIFY = "true"
  VITE_NETLIFY = "true"

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["mongoose", "bcryptjs"]

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = true

# ----------------------------
# Host-based app routing
# ----------------------------

[[redirects]]
  from = "/*"
  to = "/muse/:splat"
  status = 200
  force = true
  conditions = { Host = [
    "muse.tripleamusic.org",
    "muse.tripleamusic.com",
    "muse.triplea.netlify.app",
    "muse.tripleaevents.netlify.app",
    "tripleamuse.com",
    "www.tripleamuse.com",
  ] }

[[redirects]]
  from = "/*"
  to = "/musician/:splat"
  status = 200
  force = true
  conditions = { Host = [
    "musician.tripleamusic.org",
    "musician.tripleamusic.com",
    "musician.triplea.netlify.app",
    "musician.tripleaevents.netlify.app",
    "tripleamusician.com",
    "www.tripleamusician.com",
  ] }

[[redirects]]
  from = "/*"
  to = "/music/:splat"
  status = 200
  force = true
  conditions = { Host = [
    "music.tripleamusic.org",
    "music.tripleamusic.com",
    "music.triplea.netlify.app",
    "music.tripleaevents.netlify.app",
    "tripleamusic.org",
    "www.tripleamusic.org",
    "tripleamusic.com",
    "www.tripleamusic.com",
  ] }

# ----------------------------
# SPA fallbacks
# ----------------------------

[[redirects]]
  from = "/muse/*"
  to = "/muse/index.html"
  status = 200

[[redirects]]
  from = "/musician/*"
  to = "/musician/index.html"
  status = 200

[[redirects]]
  from = "/music/*"
  to = "/music/index.html"
  status = 200

# Default/root domain → Music
[[redirects]]
  from = "/*"
  to = "/music/index.html"
  status = 200
