# Triple A Apps - Unified Netlify Configuration
# Single site with host-based subdomain routing
#
# Deploy domains:
#   - muse.tripleamusic.org  → /muse/*
#   - music.tripleamusic.org → /music/*
#   - musician.tripleamusic.org → /musician/*
#   - tripleamusic.org (root) → /music/* (default)

[build]
  publish = "dist"
  command = "npm install && npm run build"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"

# Netlify Functions configuration (shared API)
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["mongoose"]

# Security headers for all routes
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"

# ============================================
# API REDIRECTS (must come first - highest priority)
# ============================================
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = true

# ============================================
# HOST-BASED SUBDOMAIN ROUTING
# ============================================

# MUSE subdomain → /muse/*
[[redirects]]
  from = "/*"
  to = "/muse/:splat"
  status = 200
  force = true
  conditions = {Host = ["muse.tripleamusic.org", "muse.tripleamusic.com", "muse.triplea.netlify.app"]}

# MUSICIAN subdomain → /musician/*
[[redirects]]
  from = "/*"
  to = "/musician/:splat"
  status = 200
  force = true
  conditions = {Host = ["musician.tripleamusic.org", "musician.tripleamusic.com", "musician.triplea.netlify.app"]}

# MUSIC subdomain → /music/*
[[redirects]]
  from = "/*"
  to = "/music/:splat"
  status = 200
  force = true
  conditions = {Host = ["music.tripleamusic.org", "music.tripleamusic.com", "music.triplea.netlify.app"]}

# ============================================
# DEFAULT / ROOT DOMAIN → MUSIC (fallback)
# ============================================
[[redirects]]
  from = "/*"
  to = "/music/:splat"
  status = 200
