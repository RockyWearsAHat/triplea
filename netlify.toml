# Triple A Apps - Unified Netlify Configuration
# Single site with host-based subdomain routing
#
# Deploy domains:
#   - tripleaevents.netlify.app (current Netlify domain)
#   - muse.tripleamusic.org  → /muse/*
#   - music.tripleamusic.org → /music/*
#   - musician.tripleamusic.org → /musician/*
#   - tripleamusic.org (root) → /music/* (default)
#
# Note: Subdomain routing (music.tripleaevents.netlify.app) requires
# custom domain setup in Netlify. Use the main domain for testing.

[build]
  publish = "dist"
  command = "npm install && npm install --prefix server && npm install --prefix TripleAMusic && npm install --prefix TripleAMusician && npm install --prefix TripleAMuse && npm run build"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"
  NETLIFY = "true"

# Netlify Functions configuration (shared API)
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
  external_node_modules = ["mongoose", "bcryptjs"]

# Security headers for all routes
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"

# ============================================
# API REDIRECTS (must come first - highest priority)
# ============================================
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = true

# ============================================
# HOST-BASED SUBDOMAIN ROUTING
# ============================================

# MUSE subdomain → /muse/*
[[redirects]]
  from = "/*"
  to = "/muse/:splat"
  status = 200
  force = true
  conditions = {Host = ["muse.tripleamusic.org", "muse.tripleamusic.com", "muse.triplea.netlify.app", "muse.tripleaevents.netlify.app"]}

# MUSICIAN subdomain → /musician/*
[[redirects]]
  from = "/*"
  to = "/musician/:splat"
  status = 200
  force = true
  conditions = {Host = ["musician.tripleamusic.org", "musician.tripleamusic.com", "musician.triplea.netlify.app", "musician.tripleaevents.netlify.app"]}

# MUSIC subdomain → /music/*
[[redirects]]
  from = "/*"
  to = "/music/:splat"
  status = 200
  force = true
  conditions = {Host = ["music.tripleamusic.org", "music.tripleamusic.com", "music.triplea.netlify.app", "music.tripleaevents.netlify.app"]}

# ============================================
# SPA FALLBACK RULES (per-app)
# These ensure client-side routing works for each app
# ============================================

# MUSE app SPA fallback
[[redirects]]
  from = "/muse/*"
  to = "/muse/index.html"
  status = 200

# MUSICIAN app SPA fallback
[[redirects]]
  from = "/musician/*"
  to = "/musician/index.html"
  status = 200

# MUSIC app SPA fallback
[[redirects]]
  from = "/music/*"
  to = "/music/index.html"
  status = 200

# ============================================
# DEFAULT / ROOT DOMAIN → MUSIC (fallback)
# ============================================
[[redirects]]
  from = "/*"
  to = "/music/index.html"
  status = 200
